<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deteksi Kemiripan Tema - Monitoring Proksi KK E</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-dark: #1557b0;
            --secondary-color: #34a853;
            --warning-color: #ea4335;
            --warning-light: #fce8e6;
            --orange-color: #fa7b17;
            --orange-light: #fef3e6;
            --yellow-color: #f9ab00;
            --yellow-light: #fef7e0;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .nav-links {
            margin-top: 1rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            font-size: 0.85rem;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* Control Panel */
        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .control-panel h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .threshold-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .threshold-control label,
        .search-control label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .search-control input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .threshold-slider {
            flex: 1;
            min-width: 200px;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, var(--secondary-color) 0%, var(--yellow-color) 50%, var(--warning-color) 100%);
            outline: none;
        }

        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .threshold-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            min-width: 60px;
            text-align: center;
        }

        /* Summary Cards */
        .summary-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .summary-card.high {
            border-left: 4px solid #b91c1c;
        }

        .summary-card.medium {
            border-left: 4px solid #b45309;
        }

        .summary-card.low {
            border-left: 4px solid #047857;
        }

        .summary-card.total {
            border-left: 4px solid var(--primary-color);
        }

        .summary-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .summary-card.high .number { color: #b91c1c; }
        .summary-card.medium .number { color: #b45309; }
        .summary-card.low .number { color: #047857; }
        .summary-card.total .number { color: var(--primary-color); }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Results Section */
        .results-section {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .results-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-header h2 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .results-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table th {
            background: var(--bg-color);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .results-table tbody tr:hover {
            background: var(--bg-color);
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .similarity-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .similarity-badge.high {
            background: #fee2e2;
            color: #b91c1c;
        }

        .similarity-badge.medium {
            background: #fef3c7;
            color: #b45309;
        }

        .similarity-badge.low {
            background: #d1fae5;
            color: #047857;
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .student-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .student-nim {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .student-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-detail {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.3s;
        }

        .btn-detail:hover {
            background: var(--primary-dark);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            line-height: 1;
        }

        .btn-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .comparison-card {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .comparison-card h4 {
            font-size: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .comparison-item {
            margin-bottom: 1rem;
        }

        .comparison-item:last-child {
            margin-bottom: 0;
        }

        .comparison-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.35rem;
        }

        .comparison-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .keywords-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #e8f0fe;
            border-radius: 8px;
        }

        .keywords-section h4 {
            font-size: 0.9rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .keyword-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Loading & Empty States */
        .loading-state,
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .loading-state i,
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading-state i {
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--bg-color);
            border-color: var(--primary-color);
        }

        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Footer */
        footer {
            background: var(--text-primary);
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            margin-top: 2rem;
        }

        footer a {
            color: #8ab4f8;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .footer-meta {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .results-table th:nth-child(3),
            .results-table td:nth-child(3) {
                display: none;
            }

            .student-title {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1><i class="fas fa-search-plus"></i> Deteksi Kemiripan Tema (TF-IDF)</h1>
            <div style="margin: 10px 0;">
                <span style="background: rgba(255,255,255,0.15); padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.3);">KK E (Ilmu Komputer). Prodi Teknik Informatika. UNIKOM</span>
            </div>
            <p>Monitoring Proposal Skripsi - Semester Ganjil TA 2025-2026</p>
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> Dashboard</a>
                <a href="semantic_similarity.html"><i class="fas fa-brain"></i> Semantic</a>
                <a href="llm_similarity.html"><i class="fas fa-robot"></i> LLM</a>
                <a href="llm_batch.html"><i class="fas fa-layer-group"></i> LLM Batch</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <h2><i class="fas fa-sliders-h"></i> Pengaturan & Pencarian</h2>
            <div class="control-row" style="display: flex; gap: 2rem; flex-wrap: wrap; align-items: flex-end;">
                <div class="threshold-control">
                    <label for="threshold-slider">Tampilkan kemiripan di atas:</label>
                    <input type="range" id="threshold-slider" class="threshold-slider" min="20" max="80" value="40" />
                    <span id="threshold-value" class="threshold-value">40%</span>
                </div>
                <div class="search-control" style="flex: 1; min-width: 250px;">
                    <label for="search-input"><i class="fas fa-search"></i> Cari NIM / Nama:</label>
                    <input type="text" id="search-input" placeholder="Ketik NIM atau nama..." 
                           style="width: 100%; padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 0.5rem; font-size: 1rem; margin-top: 0.25rem;" />
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-section">
            <div class="summary-card total">
                <div class="number" id="total-proposals">-</div>
                <div class="label">Total Proposal</div>
            </div>
            <div class="summary-card high">
                <div class="number" id="high-similarity">-</div>
                <div class="label">Kemiripan Tinggi (≥70%)</div>
            </div>
            <div class="summary-card medium">
                <div class="number" id="medium-similarity">-</div>
                <div class="label">Kemiripan Sedang (50-69%)</div>
            </div>
            <div class="summary-card low">
                <div class="number" id="low-similarity">-</div>
                <div class="label">Kemiripan Rendah (&lt;50%)</div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Daftar Pasangan Proposal Mirip</h2>
                <span class="results-info" id="results-info">Memuat data...</span>
            </div>

            <div id="loading-state" class="loading-state">
                <i class="fas fa-spinner"></i>
                <p>Memuat dan menganalisis data proposal...</p>
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <p>Tidak ditemukan pasangan proposal dengan kemiripan di atas threshold.</p>
            </div>

            <table class="results-table" id="results-table" style="display: none;">
                <thead>
                    <tr>
                        <th style="width: 100px;">Kemiripan</th>
                        <th>Mahasiswa 1</th>
                        <th>Mahasiswa 2</th>
                        <th style="width: 100px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                </tbody>
            </table>

            <div class="pagination" id="pagination" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal Detail -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-balance-scale"></i> Detail Perbandingan</h3>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div>
                Dikembangkan oleh <a href="https://galih.eu" target="_blank">Galih Hermawan</a>
                (<a href="https://github.com/galihboy" target="_blank"><i class="fab fa-github"></i> galihboy</a>)
            </div>
            <div>
                Program Studi Teknik Informatika. Universitas Komputer Indonesia.
            </div>
            <div style="margin-top: 10px;">
                <a href="https://github.com/Galih-Hermawan-Unikom/monitoring-proksi" target="_blank">
                    <i class="fab fa-github"></i> Source Code Repository
                </a>
            </div>
            <div class="footer-meta">
                Terakhir diperbarui: 30 November 2025
            </div>
        </div>
    </footer>

    <script>
        // ==================== CONFIGURATION ====================
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTByDo6WQAT0rQMEVcL24WyJdm4gMKm4Zfjm6RYQ-prEaLvEcruqmRXKKNWXesxReA-nPqyhmH_BMAg/pub?gid=14519582&single=true&output=csv";

        // Column indices in CSV
        const COL_NIM = 1;
        const COL_NAMA = 2;
        const COL_JUDUL = 3;
        const COL_DESKRIPSI = 5;
        const COL_PROBLEM = 6;
        const COL_METODE = 7;

        // Weights for similarity calculation
        const WEIGHTS = {
            judul: 0.30,
            deskripsi: 0.30,
            problem: 0.25,
            metode: 0.15
        };

        // ==================== STOPWORDS (CDN + Domain) ====================
        let stopWords = new Set();
        
        // Fallback stopwords jika CDN gagal
        const fallbackStopWords = new Set([
            'dan', 'yang', 'di', 'pada', 'untuk', 'dengan', 'ini', 'itu', 'dari', 'ke',
            'dalam', 'atau', 'juga', 'sebagai', 'oleh', 'adalah', 'karena', 'bagi',
            'tentang', 'serta', 'terhadap', 'melalui', 'akan', 'dapat', 'telah', 'sudah',
            'belum', 'tidak', 'ada', 'lebih', 'sangat', 'hanya', 'saat', 'ketika', 'jika',
            'the', 'and', 'of', 'for', 'in', 'on', 'with', 'using', 'based', 'a', 'an', 'to'
        ]);

        // Domain-specific stopwords
        const domainStopWords = new Set([
            'sistem', 'aplikasi', 'informasi', 'metode', 'algoritma', 'web', 'website',
            'mobile', 'data', 'proses', 'hasil', 'dapat', 'akan', 'bisa', 'harus',
            'telah', 'sudah', 'belum', 'tidak', 'ada', 'sangat', 'lebih', 'kurang',
            'berdasarkan', 'terhadap', 'antara', 'menjadi', 'melalui', 'sampai',
            'sebuah', 'suatu', 'tersebut', 'yaitu', 'bahwa', 'agar', 'sehingga',
            'menggunakan', 'digunakan', 'dilakukan', 'melakukan', 'memiliki', 'dimiliki',
            'penelitian', 'bertujuan', 'tujuan', 'model', 'berbasis',
            // Tambahan: kata umum hasil stem yang tidak bermakna
            'guna', 'gunakan', 'berguna', 'pengguna', 'penggunaan',
            'buat', 'pembuat', 'pembuatan', 'dibuat', 'membuat',
            'pakai', 'pemakai', 'pemakaian', 'dipakai', 'memakai',
            'laku', 'pelaku', 'berlaku', 'melakukan', 'dilakukan',
            'kerja', 'pekerja', 'bekerja', 'mengerjakan', 'dikerjakan',
            'bantu', 'pembantu', 'membantu', 'dibantu', 'bantuan',
            'kembang', 'pengembang', 'pengembangan', 'dikembangkan', 'mengembangkan',
            'dukung', 'pendukung', 'dukungan', 'mendukung', 'didukung',
            // Kata penghubung yang sering salah di-stem
            'mengenai', 'terhadap', 'sebagai', 'merupakan', 'menunjukkan',
            'memberikan', 'menyatakan', 'menjelaskan', 'menghasilkan',
            // Kata keterangan waktu/umum
            'sebelum', 'sesudah', 'setelah', 'selama', 'kemudian',
            'pertama', 'kedua', 'ketiga', 'terakhir', 'selanjutnya',
            // Kata penghubung/keterangan umum
            'seperti', 'masih', 'hanya', 'juga', 'agar', 'supaya',
            'namun', 'tetapi', 'karena', 'sehingga', 'meskipun', 'walaupun',
            'bahkan', 'justru', 'malah', 'sangat', 'cukup', 'kurang',
            'tinggi', 'rendah', 'besar', 'kecil', 'banyak', 'sedikit',
            'sebab', 'mampu', 'secara', 'efektif', 'efisien', 'optimal',
            'utama', 'khusus', 'umum', 'langsung', 'tepat', 'benar',
            // Kata kerja umum yang sering salah di-stem
            'memahami', 'pengalaman', 'meningkat', 'meningkatkan', 'peningkatan',
            'memiliki', 'menggunakan', 'menunjukkan', 'memberikan', 'mendapatkan',
            // Kata dengan circumfix ke-...-an (sering salah di-stem)
            'kerusakan', 'keamanan', 'kebutuhan', 'kemampuan', 'kecepatan',
            'ketepatan', 'keakuratan', 'kelebihan', 'kekurangan', 'kesalahan',
            'keberhasilan', 'kegagalan', 'kepuasan', 'ketersediaan', 'kemudahan'
        ]);

        async function loadStopWords() {
            const ID_URL = "https://cdn.jsdelivr.net/npm/stopwords-iso@1.1.0/stopwords-id.json";
            const EN_URL = "https://cdn.jsdelivr.net/npm/stopwords-iso@1.1.0/stopwords-en.json";
            
            try {
                const [idResponse, enResponse] = await Promise.all([
                    fetch(ID_URL),
                    fetch(EN_URL)
                ]);
                
                if (!idResponse.ok || !enResponse.ok) {
                    throw new Error("Failed to fetch stop words");
                }
                
                const [idWords, enWords] = await Promise.all([
                    idResponse.json(),
                    enResponse.json()
                ]);
                
                stopWords = new Set([...idWords, ...enWords, ...domainStopWords]);
                console.log(`✓ Loaded ${stopWords.size} stop words`);
                return true;
            } catch (error) {
                console.warn("Failed to load stop words from CDN, using fallback:", error);
                stopWords = new Set([...fallbackStopWords, ...domainStopWords]);
                return false;
            }
        }

        // ==================== STEMMING (Indonesian + English) ====================
        
        // Protected words - jangan di-stem karena sering salah
        const protectedWords = new Set([
            'analisis', 'sentimen', 'klasifikasi', 'prediksi', 'deteksi',
            'machine', 'learning', 'deep', 'neural', 'network', 'class',
            'support', 'vector', 'decision', 'tree', 'random', 'forest',
            'naive', 'bayes', 'regression', 'clustering', 'processing',
            'recognition', 'detection', 'classification', 'prediction',
            'image', 'text', 'speech', 'natural', 'language', 'computer',
            'vision', 'artificial', 'intelligence', 'convolutional',
            'recurrent', 'transformer', 'attention', 'embedding'
        ]);
        
        // Blocklist - hasil stem yang invalid/tidak masuk akal
        const invalidStems = new Set([
            'enai', 'ntimen', 'analisi', 'clas', 'lass', 'upport',
            'ector', 'achine', 'earning', 'etwork', 'eural',
            'ahami', 'alaman', 'ingkat', 'apat', 'unya', 'adian',
            'roses', 'asil', 'alam', 'ilai', 'ukup', 'asar',
            'kerusa', 'rusak', 'rusa', 'efekt', 'aktif'
        ]);
        
        // Validasi hasil stem - harus diawali konsonan atau vokal yang valid
        function isValidStem(word) {
            if (word.length < 3) return false;
            if (invalidStems.has(word)) return false;
            // Kata valid biasanya tidak diawali dengan kombinasi huruf aneh
            const invalidStart = /^[^aiueoabcdefghijklmnopqrstuvwxyz]/i;
            if (invalidStart.test(word)) return false;
            return true;
        }
        
        function stemIndonesian(word) {
            if (word.length < 5) return word;  // Minimum 5 karakter untuk stem
            if (protectedWords.has(word)) return word;
            
            let stem = word;
            
            // Remove suffixes first (hanya suffix yang jelas)
            const suffixes = ['kan', 'nya'];  // Hapus 'an' dan 'i' karena terlalu agresif
            for (const suffix of suffixes) {
                if (stem.endsWith(suffix) && stem.length > suffix.length + 3) {
                    stem = stem.slice(0, -suffix.length);
                    break;
                }
            }
            
            // Remove prefixes (hanya prefix yang jelas, hapus 'se', 'ke', 'di' karena ambigu)
            const prefixPatterns = [
                { prefix: 'meng', replace: '' },
                { prefix: 'meny', replace: 's' },
                { prefix: 'men', replace: '' },
                { prefix: 'mem', replace: '' },
                { prefix: 'peng', replace: '' },
                { prefix: 'peny', replace: 's' },
                { prefix: 'pen', replace: '' },
                { prefix: 'pem', replace: '' },
                { prefix: 'ber', replace: '' },
                { prefix: 'ter', replace: '' }
            ];
            
            for (const { prefix, replace } of prefixPatterns) {
                if (stem.startsWith(prefix) && stem.length > prefix.length + 3) {
                    const newStem = replace + stem.slice(prefix.length);
                    if (newStem.length >= 4) {
                        stem = newStem;
                        break;
                    }
                }
            }
            
            return stem.length >= 4 ? stem : word;
        }
        
        function stemEnglish(word) {
            if (word.length < 5) return word;
            if (protectedWords.has(word)) return word;
            
            let stem = word;
            
            // Hanya suffix yang aman
            const suffixes = [
                { suffix: 'ization', replace: 'ize' },
                { suffix: 'ational', replace: 'ate' },
                { suffix: 'iveness', replace: 'ive' },
                { suffix: 'fulness', replace: 'ful' },
                { suffix: 'ousness', replace: 'ous' },
                { suffix: 'ation', replace: 'ate' },
                { suffix: 'ness', replace: '' },
                { suffix: 'ment', replace: '' },
                { suffix: 'able', replace: '' },
                { suffix: 'ible', replace: '' },
                { suffix: 'ing', replace: '' },
                { suffix: 'ies', replace: 'y' }
            ];
            
            for (const { suffix, replace } of suffixes) {
                if (stem.endsWith(suffix) && stem.length > suffix.length + 3) {
                    const newStem = stem.slice(0, -suffix.length) + replace;
                    if (newStem.length >= 4) {
                        stem = newStem;
                        break;
                    }
                }
            }
            
            return stem.length >= 4 ? stem : word;
        }
        
        function stem(word) {
            // Jangan stem kata yang dilindungi
            if (protectedWords.has(word)) return word;
            
            // Jangan stem kata pendek
            if (word.length < 5) return word;
            
            // Deteksi bahasa berdasarkan pola yang JELAS
            const clearIndonesianPrefix = /^(meng|meny|mem|peng|peny|pem|ber|ter)/;
            const clearIndonesianSuffix = /(kan|nya)$/;
            
            let result = word;
            
            if (clearIndonesianPrefix.test(word) || clearIndonesianSuffix.test(word)) {
                result = stemIndonesian(word);
            } else {
                const clearEnglishSuffix = /(ation|ization|iveness|fulness|ousness|ment|ness|able|ible)$/;
                if (clearEnglishSuffix.test(word)) {
                    result = stemEnglish(word);
                }
            }
            
            // Validasi hasil - jika invalid, kembalikan kata asli
            if (!isValidStem(result)) {
                return word;
            }
            
            return result;
        }

        // State
        let allProposals = [];
        let similarityPairs = [];
        let filteredPairs = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let threshold = 40;

        // ==================== TEXT PROCESSING ====================
        function preprocessText(text) {
            if (!text) return [];

            // Lowercase and remove special characters
            let cleaned = text.toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            // Tokenize, remove stopwords, and apply stemming
            let tokens = cleaned.split(' ')
                .filter(word => word.length > 2 && !stopWords.has(word))
                .map(word => {
                    const stemmed = stem(word);
                    // Check if stemmed word is also not a stopword
                    return stopWords.has(stemmed) ? null : stemmed;
                })
                .filter(word => word !== null && word.length > 2);

            return tokens;
        }

        function getTermFrequency(tokens) {
            const tf = {};
            tokens.forEach(token => {
                tf[token] = (tf[token] || 0) + 1;
            });
            // Normalize by document length
            const len = tokens.length || 1;
            for (let term in tf) {
                tf[term] = tf[term] / len;
            }
            return tf;
        }

        function buildVocabulary(documents) {
            const vocab = new Set();
            documents.forEach(doc => {
                doc.tokens.forEach(token => vocab.add(token));
            });
            return Array.from(vocab);
        }

        function calculateIDF(documents, vocabulary) {
            const idf = {};
            const N = documents.length;

            vocabulary.forEach(term => {
                const docsWithTerm = documents.filter(doc =>
                    doc.tokens.includes(term)
                ).length;
                idf[term] = Math.log((N + 1) / (docsWithTerm + 1)) + 1;
            });

            return idf;
        }

        function getTFIDFVector(tf, idf, vocabulary) {
            return vocabulary.map(term => (tf[term] || 0) * (idf[term] || 0));
        }

        function cosineSimilarity(vecA, vecB) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;

            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }

            normA = Math.sqrt(normA);
            normB = Math.sqrt(normB);

            if (normA === 0 || normB === 0) return 0;
            return dotProduct / (normA * normB);
        }

        // ==================== SIMILARITY CALCULATION ====================
        function calculateFieldSimilarity(docs, fieldName) {
            const documents = docs.map(d => ({
                tokens: d[fieldName + 'Tokens'],
                tf: getTermFrequency(d[fieldName + 'Tokens'])
            }));

            const vocabulary = buildVocabulary(documents);
            if (vocabulary.length === 0) return new Array(docs.length).fill(0).map(() => new Array(docs.length).fill(0));

            const idf = calculateIDF(documents, vocabulary);

            const vectors = documents.map(doc => getTFIDFVector(doc.tf, idf, vocabulary));

            // Calculate pairwise similarity
            const n = docs.length;
            const similarities = [];

            for (let i = 0; i < n; i++) {
                similarities[i] = [];
                for (let j = 0; j < n; j++) {
                    if (i === j) {
                        similarities[i][j] = 1;
                    } else if (j < i) {
                        similarities[i][j] = similarities[j][i];
                    } else {
                        similarities[i][j] = cosineSimilarity(vectors[i], vectors[j]);
                    }
                }
            }

            return similarities;
        }

        function calculateAllSimilarities() {
            const n = allProposals.length;

            // Calculate similarity for each field
            const judulSim = calculateFieldSimilarity(allProposals, 'judul');
            const deskripsiSim = calculateFieldSimilarity(allProposals, 'deskripsi');
            const problemSim = calculateFieldSimilarity(allProposals, 'problem');
            const metodeSim = calculateFieldSimilarity(allProposals, 'metode');

            // Combine with weights
            similarityPairs = [];

            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    const weightedSim =
                        WEIGHTS.judul * judulSim[i][j] +
                        WEIGHTS.deskripsi * deskripsiSim[i][j] +
                        WEIGHTS.problem * problemSim[i][j] +
                        WEIGHTS.metode * metodeSim[i][j];

                    const percentage = Math.round(weightedSim * 100);

                    if (percentage > 0) {
                        similarityPairs.push({
                            index1: i,
                            index2: j,
                            proposal1: allProposals[i],
                            proposal2: allProposals[j],
                            similarity: percentage,
                            details: {
                                judul: Math.round(judulSim[i][j] * 100),
                                deskripsi: Math.round(deskripsiSim[i][j] * 100),
                                problem: Math.round(problemSim[i][j] * 100),
                                metode: Math.round(metodeSim[i][j] * 100)
                            }
                        });
                    }
                }
            }

            // Sort by similarity descending
            similarityPairs.sort((a, b) => b.similarity - a.similarity);
        }

        function findCommonKeywords(tokens1, tokens2) {
            const set1 = new Set(tokens1);
            const common = tokens2.filter(t => set1.has(t));
            // Remove duplicates and get top keywords
            return [...new Set(common)].slice(0, 10);
        }

        // ==================== DATA LOADING ====================
        function loadData() {
            Papa.parse(csvUrl, {
                download: true,
                header: false,
                complete: function(results) {
                    const rawData = results.data;
                    if (!rawData || rawData.length <= 1) {
                        showError("Tidak ada data proposal.");
                        return;
                    }

                    // Skip header row and filter valid data
                    allProposals = rawData.slice(1)
                        .filter(row => Array.isArray(row) && row.length > 7 && row[COL_NIM])
                        .map(row => ({
                            nim: row[COL_NIM] || '',
                            nama: row[COL_NAMA] || '',
                            judul: row[COL_JUDUL] || '',
                            deskripsi: row[COL_DESKRIPSI] || '',
                            problem: row[COL_PROBLEM] || '',
                            metode: row[COL_METODE] || '',
                            // Preprocessed tokens
                            judulTokens: preprocessText(row[COL_JUDUL]),
                            deskripsiTokens: preprocessText(row[COL_DESKRIPSI]),
                            problemTokens: preprocessText(row[COL_PROBLEM]),
                            metodeTokens: preprocessText(row[COL_METODE]),
                            // Combined tokens for keyword extraction
                            allTokens: [
                                ...preprocessText(row[COL_JUDUL]),
                                ...preprocessText(row[COL_DESKRIPSI]),
                                ...preprocessText(row[COL_PROBLEM]),
                                ...preprocessText(row[COL_METODE])
                            ]
                        }));

                    document.getElementById('total-proposals').textContent = allProposals.length;

                    if (allProposals.length < 2) {
                        showEmpty("Minimal 2 proposal diperlukan untuk analisis kemiripan.");
                        return;
                    }

                    // Calculate similarities
                    calculateAllSimilarities();

                    // Update UI
                    filterAndDisplay();
                },
                error: function(error) {
                    showError("Gagal memuat data: " + error.message);
                }
            });
        }

        // ==================== UI FUNCTIONS ====================
        function updateSummary() {
            const high = filteredPairs.filter(p => p.similarity >= 70).length;
            const medium = filteredPairs.filter(p => p.similarity >= 50 && p.similarity < 70).length;
            const low = filteredPairs.filter(p => p.similarity < 50).length;

            document.getElementById('high-similarity').textContent = high;
            document.getElementById('medium-similarity').textContent = medium;
            document.getElementById('low-similarity').textContent = low;
        }

        function filterAndDisplay() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            filteredPairs = similarityPairs.filter(p => {
                // Filter by threshold
                if (p.similarity < threshold) return false;
                
                // Filter by search term (NIM atau Nama)
                if (searchTerm) {
                    const matchProposal1 = 
                        p.proposal1.nim.toLowerCase().includes(searchTerm) ||
                        p.proposal1.nama.toLowerCase().includes(searchTerm);
                    const matchProposal2 = 
                        p.proposal2.nim.toLowerCase().includes(searchTerm) ||
                        p.proposal2.nama.toLowerCase().includes(searchTerm);
                    if (!matchProposal1 && !matchProposal2) return false;
                }
                
                return true;
            });
            
            currentPage = 1;

            updateSummary();
            renderTable();
            renderPagination();

            document.getElementById('loading-state').style.display = 'none';

            if (filteredPairs.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('results-table').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';
                document.getElementById('results-info').textContent = searchTerm 
                    ? `Tidak ditemukan hasil untuk "${searchTerm}"` 
                    : 'Tidak ada hasil';
            } else {
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('results-table').style.display = 'table';
                document.getElementById('pagination').style.display = 'flex';
                document.getElementById('results-info').textContent = searchTerm
                    ? `Ditemukan ${filteredPairs.length} pasang proposal untuk "${searchTerm}"`
                    : `Ditemukan ${filteredPairs.length} pasang proposal mirip`;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('results-body');
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = Math.min(startIdx + itemsPerPage, filteredPairs.length);
            const pageData = filteredPairs.slice(startIdx, endIdx);

            if (pageData.length === 0) {
                tbody.innerHTML = '';
                return;
            }

            tbody.innerHTML = pageData.map((pair, idx) => {
                const globalIdx = startIdx + idx;
                const simClass = pair.similarity >= 70 ? 'high' :
                                 pair.similarity >= 50 ? 'medium' : 'low';

                return `
                    <tr>
                        <td>
                            <span class="similarity-badge ${simClass}">
                                <i class="fas fa-${simClass === 'high' ? 'exclamation-circle' :
                                                   simClass === 'medium' ? 'exclamation-triangle' :
                                                   'info-circle'}"></i>
                                ${pair.similarity}%
                            </span>
                        </td>
                        <td>
                            <div class="student-info">
                                <span class="student-name">${escapeHtml(pair.proposal1.nama)}</span>
                                <span class="student-nim">${escapeHtml(pair.proposal1.nim)}</span>
                                <span class="student-title" title="${escapeHtml(pair.proposal1.judul)}">
                                    ${escapeHtml(truncate(pair.proposal1.judul, 50))}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="student-info">
                                <span class="student-name">${escapeHtml(pair.proposal2.nama)}</span>
                                <span class="student-nim">${escapeHtml(pair.proposal2.nim)}</span>
                                <span class="student-title" title="${escapeHtml(pair.proposal2.judul)}">
                                    ${escapeHtml(truncate(pair.proposal2.judul, 50))}
                                </span>
                            </div>
                        </td>
                        <td>
                            <button class="btn-detail" onclick="openModal(${globalIdx})">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredPairs.length / itemsPerPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            let html = '';

            // Previous button
            html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})"
                     ${currentPage === 1 ? 'disabled' : ''}>
                     <i class="fas fa-chevron-left"></i>
                     </button>`;

            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            startPage = Math.max(1, endPage - 4);

            if (startPage > 1) {
                html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 0.5rem;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}"
                         onclick="goToPage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="padding: 0.5rem;">...</span>`;
                }
                html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})"
                     ${currentPage === totalPages ? 'disabled' : ''}>
                     <i class="fas fa-chevron-right"></i>
                     </button>`;

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredPairs.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            renderPagination();
            document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(pairIndex) {
            const pair = filteredPairs[pairIndex];
            if (!pair) return;

            const commonKeywords = findCommonKeywords(
                pair.proposal1.judulTokens,
                pair.proposal2.judulTokens
            );

            const simClass = pair.similarity >= 70 ? 'high' :
                             pair.similarity >= 50 ? 'medium' : 'low';
            const getSimClass = (val) => val >= 70 ? 'high' : val >= 50 ? 'medium' : 'low';

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <span class="similarity-badge ${simClass}" style="font-size: 1.2rem; padding: 0.5rem 1.5rem;">
                        <i class="fas fa-percentage"></i>
                        Kemiripan: ${pair.similarity}%
                    </span>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.75rem;">
                        <span class="similarity-badge ${getSimClass(pair.details.judul)}" style="font-size: 0.85rem;">Judul: ${pair.details.judul}%</span>
                        <span class="similarity-badge ${getSimClass(pair.details.deskripsi)}" style="font-size: 0.85rem;">Deskripsi: ${pair.details.deskripsi}%</span>
                        <span class="similarity-badge ${getSimClass(pair.details.problem)}" style="font-size: 0.85rem;">Problem: ${pair.details.problem}%</span>
                        <span class="similarity-badge ${getSimClass(pair.details.metode)}" style="font-size: 0.85rem;">Metode: ${pair.details.metode}%</span>
                    </div>
                </div>

                <div class="comparison-grid">
                    <div class="comparison-card">
                        <h4><i class="fas fa-user"></i> ${escapeHtml(pair.proposal1.nama)}</h4>
                        <div class="comparison-item">
                            <div class="comparison-label">NIM</div>
                            <div class="comparison-text">${escapeHtml(pair.proposal1.nim)}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Judul</div>
                            <div class="comparison-text">${escapeHtml(pair.proposal1.judul)}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Deskripsi</div>
                            <div class="comparison-text">${escapeHtml(truncate(pair.proposal1.deskripsi, 300))}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Problem Statement</div>
                            <div class="comparison-text">${escapeHtml(truncate(pair.proposal1.problem, 300))}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Metode</div>
                            <div class="comparison-text">${escapeHtml(pair.proposal1.metode)}</div>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <h4><i class="fas fa-user"></i> ${escapeHtml(pair.proposal2.nama)}</h4>
                        <div class="comparison-item">
                            <div class="comparison-label">NIM</div>
                            <div class="comparison-text">${escapeHtml(pair.proposal2.nim)}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Judul</div>
                            <div class="comparison-text">${escapeHtml(pair.proposal2.judul)}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Deskripsi</div>
                            <div class="comparison-text">${escapeHtml(truncate(pair.proposal2.deskripsi, 300))}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Problem Statement</div>
                            <div class="comparison-text">${escapeHtml(truncate(pair.proposal2.problem, 300))}</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">Metode</div>
                            <div class="comparison-text">${escapeHtml(pair.proposal2.metode)}</div>
                        </div>
                    </div>
                </div>

                ${commonKeywords.length > 0 ? `
                    <div class="keywords-section">
                        <h4><i class="fas fa-key"></i> Kata Kunci yang Sama</h4>
                        <div class="keyword-tags">
                            ${commonKeywords.map(kw => `<span class="keyword-tag">${escapeHtml(kw)}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            document.getElementById('modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ==================== UTILITY FUNCTIONS ====================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncate(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <i class="fas fa-exclamation-circle" style="color: var(--warning-color);"></i>
                <p>${message}</p>
            `;
        }

        function showEmpty(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('empty-state').innerHTML = `
                <i class="fas fa-info-circle"></i>
                <p>${message}</p>
            `;
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('threshold-slider').addEventListener('input', function(e) {
            threshold = parseInt(e.target.value);
            document.getElementById('threshold-value').textContent = threshold + '%';
        });

        document.getElementById('threshold-slider').addEventListener('change', function() {
            filterAndDisplay();
        });

        // Search input
        document.getElementById('search-input').addEventListener('input', function() {
            filterAndDisplay();
        });

        // Close modal on overlay click
        document.getElementById('modal-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Load stopwords first, then load data
            document.getElementById('loading-state').innerHTML = 
                '<i class="fas fa-spinner fa-spin"></i> Memuat kamus stopwords...';
            await loadStopWords();
            
            document.getElementById('loading-state').innerHTML = 
                '<i class="fas fa-spinner fa-spin"></i> Menghitung kemiripan dengan stemming...';
            loadData();
        });
    </script>
</body>
</html>
